<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Launchpad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-image: linear-gradient(to top, #e6e9f0 0%, #eef2f3 100%);
            color: #495057;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            padding: 40px;
            border: 1px solid #dee2e6;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
            margin-top: 0;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .instructions {
            background-color: #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #ced4da;
        }
        .instructions h2 {
            margin-top: 0;
            font-size: 18px;
            font-weight: 600;
            color: #343a40;
        }
        .instructions ol {
            padding-left: 0;
            list-style: none;
            margin-bottom: 0;
            line-height: 1.6;
        }
        .instructions li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .instructions li:last-child {
            margin-bottom: 0;
        }
        .pipeline-group {
            background-color: #f7f9fc;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            transition: box-shadow 0.2s ease-in-out;
        }
        .pipeline-group:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .pipeline-group h3 {
            margin-top: 0;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #343a40;
        }
        .group-label {
            font-weight: 500;
            color: #6c757d;
            margin-right: 8px;
            font-size: 18px;
        }
        .pipeline-group label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .pipeline-group label:hover {
            background-color: #f8f9fa;
        }
        .monitored-dir {
            font-size: 12px;
            font-family: monospace;
            color: #6c757d;
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .dir-path {
            font-family: monospace;
        }
        .copy-icon {
            cursor: pointer;
            color: #6c757d;
        }
        .copy-icon:hover {
            color: #0d6efd;
        }
        .controls {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease-in-out;
        }
        button.btn-secondary {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #ced4da;
            margin-right: 10px;
        }
        button.btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        #runImportsButton {
            background-color: #0d6efd;
            color: white;
        }
        #runImportsButton:disabled {
            background-color: #6ea8fe;
            cursor: not-allowed;
        }
        #runImportsButton:hover:not(:disabled) {
            background-color: #0b5ed7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
        }
        #shutdownButton {
            background-color: #dc3545;
            color: white;
            margin-top: 20px;
            width: 100%;
        }
        #shutdownButton:hover {
            background-color: #bb2d3b;
        }
        #status-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out;
            border: 1px solid #e9ecef;
        }
        #status-container h4 {
            margin-top: 0;
            font-size: 18px;
            font-weight: 600;
            color: #343a40;
        }
        #runStatusList {
            list-style-type: none;
            padding: 0;
            font-size: 14px;
            line-height: 1.8;
        }
        #runStatusList li {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #runStatusList li .import-name-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #runStatusList li .import-name {
            font-weight: 500;
        }
        #runStatusList li:last-child {
            border-bottom: none;
        }
        .status-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        .status-SUCCESS { background-color: #19875426; color: #146c43; }
        .status-FAILURE, .status-POLLING_FAILED { background-color: #dc354526; color: #b02a37; }
        .status-STARTING, .status-QUEUED { background-color: #ffc10726; color: #997404; }
        .status-RUNNING { background-color: #0dcaf026; color: #0a8299; }
        .status-NOT_TRIGGERED { background-color: #6c757d26; color: #565e64; }
        .status-TRIGGERING { background-color: #6c757d26; color: #565e64; }
        
        .loader {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #6c757d;
        }
        .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .instructions .icon {
            margin-right: 12px;
        }
        .icon-step0 { color: #fd7e14; }
        .icon-step1 { color: #0d6efd; }
        .icon-step2 { color: #198754; }
        .icon-step3 { color: #ffc107; }
        .icon-step4 { color: #6f42c1; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <h1>Data Hub</h1>
        <button id="analyticsButton" class="btn-secondary" style="font-size: 14px; padding: 8px 16px;">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>
            Open Analytics Hub
        </button>
    </div>

    <div class="instructions">
        <h2>How to Use This Tool</h2>
        <ol>
            <li><svg class="icon icon-step0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg><div><strong>Ingestion (Optional):</strong> Run scrapers or downloaders to fetch data files automatically.</div></li>
            <li><svg class="icon icon-step1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" /></svg><div><strong>Place File:</strong> Before starting, ensure the data file you want to import is placed in the correct monitored directory for the data source.</div></li>
            <li><svg class="icon icon-step2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div><strong>Select Imports:</strong> Check the boxes for the data imports you wish to run. You can use the "Select All" button to choose all available imports.</div></li>
            <li><svg class="icon icon-step3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" /></svg><div><strong>Run Imports:</strong> Click the "Run Selected Imports" button. This will trigger the corresponding sensors in the background.</div></li>
            <li><svg class="icon icon-step4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25z" /></svg><div><strong>Monitor Status:</strong> The status of each import will appear below. A sensor will only trigger a run if its conditions are met (e.g., a new file is present).</div></li>
        </ol>
    </div>

    <div id="pipeline-list">
        <div class="loader">Loading available imports...</div>
    </div>

    <div class="controls">
        <div>
            <button id="selectAllButton" class="btn-secondary"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Select All</button>
            <button id="deselectAllButton" class="btn-secondary"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Deselect All</button>
        </div>
        <button id="runImportsButton" disabled><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>Run Selected Imports</button>        
    </div>

    <div id="status-container">
        <h4>Import Status</h4>
        <ul id="runStatusList"></ul>
    </div>

    <div>
        <button id="shutdownButton"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" /></svg>Shutdown Application</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pipelineListDiv = document.getElementById('pipeline-list');
    const runImportsButton = document.getElementById('runImportsButton');
    const selectAllButton = document.getElementById('selectAllButton');
    const deselectAllButton = document.getElementById('deselectAllButton');
    const shutdownButton = document.getElementById('shutdownButton');
    const statusContainer = document.getElementById('status-container');
    const runStatusList = document.getElementById('runStatusList');
    const analyticsButton = document.getElementById('analyticsButton');

    let activePollers = {};

    // --- 1. Fetch and Render Pipelines ---
    async function fetchPipelines() {
        try {
            const response = await fetch('/api/pipelines');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load pipelines from server.');
            }
            const pipelines = await response.json();

            pipelineListDiv.innerHTML = ''; // Clear loader
            if (pipelines.length === 0) {
                pipelineListDiv.innerHTML = '<p>No active pipelines found in the database.</p>';
                return;
            }

            pipelines.forEach(pipeline => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'pipeline-group';

                let dirHtml = pipeline.monitored_directory ? `<span class="monitored-dir"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg><code class="dir-path">${pipeline.monitored_directory}</code><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon copy-icon" data-path="${pipeline.monitored_directory}"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg></span>` : '';
                groupDiv.innerHTML = `<h3><div><span class="group-label">Data Source:</span>${pipeline.pipeline_name}</div> ${dirHtml}</h3>`;

                // Helper to render sections
                const renderSection = (items, title, iconSvg, iconColor) => {
                    if (items && items.length > 0) {
                        if (title) {
                            const header = document.createElement('div');
                            header.style.cssText = "margin: 15px 0 5px; font-size: 0.75rem; text-transform: uppercase; color: #6c757d; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center;";
                            if (iconSvg) {
                                header.innerHTML = `<span style="color: ${iconColor}; margin-right: 6px; display: flex;">${iconSvg}</span> ${title}`;
                            } else {
                                header.innerText = title;
                            }
                            groupDiv.appendChild(header);
                        }
                        items.forEach(item => {
                            const importName = item.import_name;
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" class="import-checkbox" data-import-name="${importName}"> ${importName}`;
                            groupDiv.appendChild(label);
                        });
                    }
                };

                const ingestIcon = `<svg class="icon" style="width: 14px; height: 14px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>`;
                const processIcon = `<svg class="icon" style="width: 14px; height: 14px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>`;

                renderSection(pipeline.ingest_imports, "Ingestion", ingestIcon, "#fd7e14");
                renderSection(pipeline.load_imports, "Processing (ELT)", processIcon, "#0d6efd");

                pipelineListDiv.appendChild(groupDiv);
            });
            addCopyListeners();
            runImportsButton.disabled = false; // Enable button after loading
        } catch (error) {
            pipelineListDiv.innerHTML = `<div class="loader" style="color: #dc3545;">Error: ${error.message}</div>`;
        }
    }

    // --- 2. Handle "Run Imports" Click ---
    runImportsButton.addEventListener('click', async function() {
        const selectedCheckboxes = document.querySelectorAll('.import-checkbox:checked');
        const selectedImports = Array.from(selectedCheckboxes).map(cb => ({
            import_name: cb.dataset.importName
        }));

        if (selectedImports.length === 0) {
            alert("Please select at least one import to run.");
            return;
        }

        // --- UI Feedback: Start ---
        runImportsButton.disabled = true;
        statusContainer.style.display = 'block';
        runStatusList.innerHTML = '';

        const initialStatuses = {};
        selectedImports.forEach(item => {
            const importName = item.import_name;
            const li = document.createElement('li');
            li.id = `status-${importName}`;
            li.innerHTML = `<div class="import-name-wrapper"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="import-name">${importName}</span></div> <span class="status-tag status-TRIGGERING">Triggering...</span>`;
            runStatusList.appendChild(li);
            initialStatuses[importName] = li;
        });

        // --- API Call ---
        try {
            const response = await fetch('/api/run_imports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imports: selectedImports }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to trigger imports.');
            }

            const data = await response.json();
            const results = data.results || [];

            // Update statuses based on backend results
            results.forEach(result => {
                const li = document.getElementById(`status-${result.import_name}`);
                if (!li) return;

                delete initialStatuses[result.import_name]; // Mark as processed

                if (result.status === 'launched') {
                    li.innerHTML = `<div class="import-name-wrapper"><svg class="icon spinner-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691V5.25a2.25 2.25 0 00-2.25-2.25L10.5 3z" /></svg><span class="import-name">${result.import_name}</span></div> <span class="status-tag status-STARTING">Starting</span>`;
                    startPollingRunStatus(result.run_id, result.import_name);
                } else if (result.status === 'skipped') {
                    li.innerHTML = `<div class="import-name-wrapper"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg><span class="import-name">${result.import_name}</span></div> <span class="status-tag status-NOT_TRIGGERED" title="${result.error}">Skipped</span>`;
                } else {
                    // Error
                    li.innerHTML = `<div class="import-name-wrapper"><svg class="icon" style="color: #b02a37;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg><span class="import-name">${result.import_name}</span></div> <span class="status-tag status-FAILURE" title="${result.error}">Error</span>`;
                }
            });

            // Update statuses for imports that were NOT returned by backend (fallback)
            for (const importName in initialStatuses) {
                const li = initialStatuses[importName];
                li.innerHTML = `<div class="import-name-wrapper"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg><span class="import-name">${importName}</span></div> <span class="status-tag status-NOT_TRIGGERED">Not Triggered</span>`;
            }

            if (Object.keys(activePollers).length === 0) {
                // If no runs were triggered at all
                runImportsButton.disabled = false;
            }

        } catch (error) {
            runStatusList.innerHTML = `<li style="justify-content: center; color: #842029;"><strong>API Error:</strong> ${error.message}</li>`;
            runImportsButton.disabled = false;
        }
    });

    // --- 3. Poll for Run Status ---
    function startPollingRunStatus(runId, importName) {
        if (activePollers[runId]) clearInterval(activePollers[runId]);

        const listItem = document.getElementById(`status-${importName}`);

        const poller = setInterval(async () => {
            try {
                const response = await fetch(`/api/run_status/${runId}`);
                if (!response.ok) throw new Error('Polling failed.');
                
                const data = await response.json();
                const status = data.status;

                let iconHtml = '';
                if (['SUCCESS'].includes(status)) {
                    iconHtml = '<svg class="icon" style="color: #146c43;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                } else if (['FAILURE', 'CANCELED'].includes(status)) {
                    iconHtml = '<svg class="icon" style="color: #b02a37;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                } else { // RUNNING, STARTING, QUEUED
                    iconHtml = '<svg class="icon spinner-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691V5.25a2.25 2.25 0 00-2.25-2.25L10.5 3z" /></svg>';
                }

                listItem.innerHTML = `<div class="import-name-wrapper">${iconHtml}<span class="import-name">${importName}</span></div> <span class="status-tag status-${status}">${status}</span>`;

                if (['SUCCESS', 'FAILURE', 'CANCELED'].includes(status)) {
                    clearInterval(poller);
                    delete activePollers[runId];
                    checkAllPollersComplete();
                }
            } catch (error) {
                const errorIcon = '<svg class="icon" style="color: #b02a37;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>';
                listItem.innerHTML = `<div class="import-name-wrapper">${errorIcon}<span class="import-name">${importName}</span></div> <span class="status-tag status-POLLING_FAILED">POLLING FAILED</span>`;
                clearInterval(poller);
                delete activePollers[runId];
                checkAllPollersComplete();
            }
        }, 3000); // Poll every 3 seconds

        activePollers[runId] = poller;
    }

    function checkAllPollersComplete() {
        if (Object.keys(activePollers).length === 0) {
            runImportsButton.disabled = false; // Re-enable the main button

            // Auto-deselect all imports
            document.querySelectorAll('.import-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
    }

    function addCopyListeners() {
        const copyIcons = document.querySelectorAll('.copy-icon');
        copyIcons.forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent any parent click events
                const path = this.dataset.path;
                navigator.clipboard.writeText(path).then(() => {
                    // Visual feedback: change to a checkmark
                    const originalIconPath = this.innerHTML;
                    this.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />';
                    setTimeout(() => {
                        this.innerHTML = originalIconPath; // Revert back after 1.5 seconds
                    }, 1500);
                });
            });
        });
    }

    // --- 4. Handle Selection Buttons ---
    selectAllButton.addEventListener('click', () => {
        document.querySelectorAll('.import-checkbox').forEach(cb => {
            cb.checked = true;
        });
    });

    deselectAllButton.addEventListener('click', () => {
        document.querySelectorAll('.import-checkbox').forEach(cb => {
            cb.checked = false;
        });
    });

    // --- 5. Handle Shutdown ---
    shutdownButton.addEventListener('click', async () => {
        if (confirm("Are you sure you want to shut down the application?")) {
            try {
                await fetch('/api/shutdown', { method: 'POST' });
                document.body.innerHTML = '<h1>Application is shutting down... You can close this window.</h1>';
            } catch (e) {
                document.body.innerHTML = '<h1>Could not reach server to shut down. Please close the launcher script window.</h1>';
            }
        }
    });

    // --- 6. Handle Analytics Button ---
    analyticsButton.addEventListener('click', () => {
        const host = window.location.hostname;
        window.open(`http://${host}:8501`, '_blank');
    });

    // --- Initial Load ---
    fetchPipelines();
});
</script>

</body>
</html>